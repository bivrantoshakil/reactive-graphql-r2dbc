<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <property name="LOG_CHARSET" value="UTF-8" />
    <property name="CONSOLE_LOG_PATTERN" value="level:[%level] %magenta([%thread]) message:[%msg] timeStamp:[%d{yyyy-MM-dd'T'HH:mm:ss.SSS'Z',UTC}] %logger{36}%n" />
    <property name="APP_LOGS_HOME_PATH" value="./applogs" />
    <appender name="STD_OUT" class="ch.qos.logback.core.ConsoleAppender">
        <layout class="ch.qos.logback.classic.PatternLayout">
            <pattern>${CONSOLE_LOG_PATTERN}</pattern>
        </layout>
    </appender>
    <appender name="INFO_LOG" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${APP_LOGS_HOME_PATH}/info.log</file>
        <encoder class="net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder">
            <providers>
                <pattern>
                    <Pattern>
                        {
                        "message": "%message",
                        "level": "%level",
                        "timestamp": "%d{yyyy-MM-dd'T'HH:mm:ss.SSS'Z',UTC}",
                        "exception" : "%exception{full}"
                        }
                    </Pattern>
                </pattern>
            </providers>
        </encoder>
        <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
            <fileNamePattern>${APP_LOGS_HOME_PATH}/archived/info-%d{yyyy-MM-dd}.%i.gz</fileNamePattern>
            <maxFileSize>100MB</maxFileSize>
            <maxHistory>100</maxHistory>
            <totalSizeCap>20GB</totalSizeCap>
        </rollingPolicy>
        <filter class="ch.qos.logback.classic.filter.LevelFilter">
            <level>INFO</level>
            <onMatch>ACCEPT</onMatch>
            <onMismatch>DENY</onMismatch>
        </filter>
    </appender>
    <!--    for access log-->
    <timestamp key="timestamp" datePattern="yyyy-MM-dd"/>
    <appender name="ACCESS_LOG" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${APP_LOGS_HOME_PATH}/access_log.${timestamp}.log</file>
        <encoder>
            <pattern>%msg%n</pattern>
        </encoder>
        <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
            <fileNamePattern>${APP_LOGS_HOME_PATH}/archived/access_log.%d{yyyy-MM-dd}.%i.gz</fileNamePattern>
            <maxFileSize>100MB</maxFileSize>
            <maxHistory>100</maxHistory>
            <totalSizeCap>20GB</totalSizeCap>
        </rollingPolicy>
    </appender>
    <appender name="ERROR_LOG" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${APP_LOGS_HOME_PATH}/error.log</file>
        <encoder class="net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder">
            <providers>
                <pattern>
                    <Pattern>
                        {
                        "message": "%message",
                        "level": "%level",
                        "timestamp": "%d{yyyy-MM-dd'T'HH:mm:ss.SSS'Z',UTC}",
                        "exception" : "%exception{full}"
                        }
                    </Pattern>
                </pattern>
            </providers>
        </encoder>
        <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
            <fileNamePattern>${APP_LOGS_HOME_PATH}/archived/error-%d{yyyy-MM-dd}.%i.gz</fileNamePattern>
            <maxFileSize>100MB</maxFileSize>
            <maxHistory>100</maxHistory>
            <totalSizeCap>20GB</totalSizeCap>
        </rollingPolicy>
        <filter class="ch.qos.logback.classic.filter.LevelFilter">
            <level>ERROR</level>
            <onMatch>ACCEPT</onMatch>
            <onMismatch>DENY</onMismatch>
        </filter>
    </appender>
    <appender name="DEBUG_LOG" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${APP_LOGS_HOME_PATH}/debug.log</file>
        <encoder class="net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder">
            <providers>
                <pattern>
                    <Pattern>
                        {
                        "message": "%message",
                        "level": "%level",
                        "timestamp": "%d{yyyy-MM-dd'T'HH:mm:ss.SSS'Z',UTC}"
                        }
                    </Pattern>
                </pattern>
            </providers>
        </encoder>
        <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
            <fileNamePattern>${APP_LOGS_HOME_PATH}/archived/debug-%d{yyyy-MM-dd}.%i.gz</fileNamePattern>
            <maxFileSize>100MB</maxFileSize>
            <maxHistory>100</maxHistory>
            <totalSizeCap>20GB</totalSizeCap>
        </rollingPolicy>
        <filter class="ch.qos.logback.classic.filter.LevelFilter">
            <level>DEBUG</level>
            <onMatch>ACCEPT</onMatch>
            <onMismatch>DENY</onMismatch>
        </filter>
    </appender>
    <springProfile name="local,mock,test">
        <logger name="org.springframework.data.cassandra.core.cql.CqlTemplate" level="debug" additivity="false">
            <appender-ref ref="STD_OUT"/>
        </logger>
        <logger name="org.springframework.data.cassandra.core.cql.ReactiveCqlTemplate" level="debug" additivity="false">
            <appender-ref ref="STD_OUT"/>
        </logger>
    </springProfile>
    <!-- ALL Profiles -->
    <springProfile name="default,local,test,mock,stg,pre,prod">
        <root level="${logging.level.root}">
            <appender-ref ref="STD_OUT" />
        </root>
        <logger name="jp.co.rakuten.link.communities.user.generated.content" level="${logging.level.root}" additivity="false">
            <appender-ref ref="STD_OUT"/>
            <appender-ref ref="DEBUG_LOG"/>
            <appender-ref ref="INFO_LOG"/>
            <appender-ref ref="ERROR_LOG"/>
        </logger>
        <logger name="reactor.netty.http.server.AccessLog" level="${logging.level.root}" additivity="false">
            <appender-ref ref="ACCESS_LOG"/>
        </logger>
    </springProfile>
</configuration>
